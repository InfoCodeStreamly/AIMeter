#!/bin/bash
# Pre-push hook: blocks push if SPM tests fail
#
# Install:  cp scripts/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push
# Skip:     git push --no-verify

set -e

# Skip if tests passed <60s ago (avoids double-run in stageâ†’main workflow)
MARKER="/tmp/.aimeter-tests-passed"
if [ -f "$MARKER" ]; then
    AGE=$(( $(date +%s) - $(stat -f %m "$MARKER") ))
    if [ "$AGE" -lt 60 ]; then
        exit 0
    fi
fi

echo "Running tests before push..."
if ! xcrun swift test 2>&1 | tail -3; then
    echo "Tests failed. Push rejected."
    rm -f "$MARKER"
    exit 1
fi

touch "$MARKER"
